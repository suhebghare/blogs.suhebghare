<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argo Rollouts & Canary Deployments | Suheb Ghare</title>
    <meta name="description" content="Production canary deployment strategy with Argo Rollouts reducing deployment risk by 90%">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Suheb Ghare</div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#blog-index">Blog Index</a>
                <a href="https://portfolio.suhebghare.tech" target="_blank">Portfolio</a>
            </div>
        </nav>
    </header>

    <main>
        <a href="index.html" class="back-link">‚Üê Back to Home</a>
        
        <article class="blog-content">
            <div class="blog-header">
                <h1>Argo Rollouts & Canary Deployments</h1>
                <div class="blog-meta">Published on December 13, 2024 | 16 min read</div>
            </div>


            <div class="blog-stats">
                <div class="stat-item">
                    <span class="icon">üëÅÔ∏è</span>
                    <span class="count reads-count">875</span>
                    <span class="label">reads</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëç</span>
                    <span class="count likes-count">221</span>
                    <span class="label">likes</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëé</span>
                    <span class="count dislikes-count">32</span>
                    <span class="label">dislikes</span>
                </div>
            </div>

            <div class="blog-actions">
                <button class="like-btn" onclick="blogStats.like('argo-rollouts-canary-deployments')">üëç Like</button>
                <button class="dislike-btn" onclick="blogStats.dislike('argo-rollouts-canary-deployments')">üëé Dislike</button>
            </div>
            <div class="info-box">
                <strong>Real Impact:</strong> Argo Rollouts with automated canary analysis reduced deployment incidents from 12/month to 1/month (90% reduction) and enabled 50+ daily deployments with zero downtime.
            </div>

            <h2>Why Canary Deployments?</h2>
            <p>Traditional blue-green deployments switch 100% of traffic instantly. If there's a bug, 100% of users are affected. Canary deployments gradually shift traffic (5% ‚Üí 25% ‚Üí 50% ‚Üí 100%), catching issues early with minimal user impact.</p>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">90%</div>
                    <div class="metric-label">Fewer Incidents</div>
                    <div class="metric-sublabel">12 ‚Üí 1 per month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">50+</div>
                    <div class="metric-label">Daily Deployments</div>
                    <div class="metric-sublabel">Zero Downtime</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">15 min</div>
                    <div class="metric-label">Avg Rollout Time</div>
                    <div class="metric-sublabel">Automated Analysis</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">100%</div>
                    <div class="metric-label">Auto Rollback</div>
                    <div class="metric-sublabel">On Failure</div>
                </div>
            </div>

            <h2>Canary Deployment Flow</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-title">Step 1: Deploy Canary (5%)</div>
                    <div class="flow-content">Route 5% traffic to new version</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Step 2: Analysis (5 min)</div>
                    <div class="flow-content">Monitor error rate, latency, success rate</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Step 3: Promote to 25%</div>
                    <div class="flow-content">If metrics pass, increase traffic</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Step 4: Promote to 50%</div>
                    <div class="flow-content">Continue gradual rollout</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Step 5: Full Rollout (100%)</div>
                    <div class="flow-content">Complete deployment or auto-rollback on failure</div>
                </div>
            </div>

            <h2>Argo Rollouts Installation</h2>

            <pre><code>kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# Install kubectl plugin
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x kubectl-argo-rollouts-linux-amd64
sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts</code></pre>

            <h2>Basic Canary Rollout</h2>

            <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api-service
  namespace: production
spec:
  replicas: 10
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: api-service
  
  template:
    metadata:
      labels:
        app: api-service
    spec:
      containers:
      - name: api
        image: api-service:v2.0.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
  
  strategy:
    canary:
      steps:
      - setWeight: 5
      - pause: {duration: 5m}
      - setWeight: 25
      - pause: {duration: 5m}
      - setWeight: 50
      - pause: {duration: 5m}
      - setWeight: 75
      - pause: {duration: 5m}</code></pre>

            <h2>Automated Analysis with Prometheus</h2>

            <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api-service
spec:
  replicas: 10
  strategy:
    canary:
      steps:
      - setWeight: 5
      - pause: {duration: 2m}
      - analysis:
          templates:
          - templateName: success-rate
          - templateName: error-rate
          - templateName: latency
      - setWeight: 25
      - pause: {duration: 2m}
      - analysis:
          templates:
          - templateName: success-rate
          - templateName: error-rate
      - setWeight: 50
      - pause: {duration: 2m}
      - setWeight: 100
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  metrics:
  - name: success-rate
    interval: 1m
    successCondition: result >= 0.95
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.monitoring:9090
        query: |
          sum(rate(http_requests_total{status=~"2..",app="api-service",version="canary"}[2m]))
          /
          sum(rate(http_requests_total{app="api-service",version="canary"}[2m]))
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: error-rate
spec:
  metrics:
  - name: error-rate
    interval: 1m
    successCondition: result <= 0.05
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.monitoring:9090
        query: |
          sum(rate(http_requests_total{status=~"5..",app="api-service",version="canary"}[2m]))
          /
          sum(rate(http_requests_total{app="api-service",version="canary"}[2m]))
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: latency
spec:
  metrics:
  - name: p99-latency
    interval: 1m
    successCondition: result <= 1000
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.monitoring:9090
        query: |
          histogram_quantile(0.99, 
            sum(rate(http_request_duration_seconds_bucket{app="api-service",version="canary"}[2m])) by (le)
          ) * 1000</code></pre>

            <h2>Traffic Management with Istio</h2>

            <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api-service
spec:
  replicas: 10
  strategy:
    canary:
      canaryService: api-service-canary
      stableService: api-service-stable
      trafficRouting:
        istio:
          virtualService:
            name: api-service
            routes:
            - primary
      steps:
      - setWeight: 5
      - pause: {duration: 2m}
      - setWeight: 25
      - pause: {duration: 2m}
      - setWeight: 50
      - pause: {duration: 2m}
      - setWeight: 100
---
apiVersion: v1
kind: Service
metadata:
  name: api-service-stable
spec:
  selector:
    app: api-service
  ports:
  - port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-service-canary
spec:
  selector:
    app: api-service
  ports:
  - port: 80
    targetPort: 8080
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-service
spec:
  hosts:
  - api.example.com
  http:
  - name: primary
    route:
    - destination:
        host: api-service-stable
      weight: 100
    - destination:
        host: api-service-canary
      weight: 0</code></pre>

            <h2>Blue-Green Deployment</h2>

            <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api-service
spec:
  replicas: 10
  strategy:
    blueGreen:
      activeService: api-service-active
      previewService: api-service-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 300
      prePromotionAnalysis:
        templates:
        - templateName: smoke-tests
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
---
apiVersion: v1
kind: Service
metadata:
  name: api-service-active
spec:
  selector:
    app: api-service
  ports:
  - port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-service-preview
spec:
  selector:
    app: api-service
  ports:
  - port: 80
    targetPort: 8080</code></pre>

            <h2>Progressive Delivery with Flagger</h2>

            <pre><code>apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: api-service
  namespace: production
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-service
  
  service:
    port: 80
    targetPort: 8080
  
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 5
    
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://api-service-canary/"</code></pre>

            <h2>Rollback Strategies</h2>

            <h3>Automatic Rollback</h3>
            <pre><code>apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: api-service
spec:
  strategy:
    canary:
      steps:
      - setWeight: 5
      - analysis:
          templates:
          - templateName: error-rate
          args:
          - name: error-threshold
            value: "0.05"
      # If analysis fails, automatic rollback occurs
      - setWeight: 25
      - setWeight: 50
      - setWeight: 100</code></pre>

            <h3>Manual Rollback</h3>
            <pre><code># Abort current rollout
kubectl argo rollouts abort api-service -n production

# Rollback to previous version
kubectl argo rollouts undo api-service -n production

# Rollback to specific revision
kubectl argo rollouts undo api-service --to-revision=3 -n production</code></pre>

            <h2>Monitoring Rollouts</h2>

            <h3>Dashboard</h3>
            <pre><code># Install Argo Rollouts Dashboard
kubectl apply -f https://github.com/argoproj/argo-rollouts/releases/latest/download/dashboard-install.yaml

# Port forward
kubectl port-forward svc/argo-rollouts-dashboard -n argo-rollouts 3100:3100

# Access at http://localhost:3100</code></pre>

            <h3>CLI Monitoring</h3>
            <pre><code># Watch rollout progress
kubectl argo rollouts get rollout api-service -n production --watch

# List rollouts
kubectl argo rollouts list rollouts -n production

# Get rollout status
kubectl argo rollouts status api-service -n production</code></pre>

            <h2>CI/CD Integration</h2>

            <pre><code>name: Deploy with Canary

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build and push image
        run: |
          docker build -t api-service:${{ github.sha }} .
          docker push api-service:${{ github.sha }}
      
      - name: Update Rollout
        run: |
          kubectl argo rollouts set image api-service \
            api=api-service:${{ github.sha }} \
            -n production
      
      - name: Wait for rollout
        run: |
          kubectl argo rollouts status api-service \
            -n production \
            --watch \
            --timeout 15m
      
      - name: Rollback on failure
        if: failure()
        run: |
          kubectl argo rollouts abort api-service -n production
          kubectl argo rollouts undo api-service -n production</code></pre>

            <h2>Best Practices</h2>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Practice</th>
                        <th>Why</th>
                        <th>Implementation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Start Small</strong></td>
                        <td>Minimize blast radius</td>
                        <td>Begin with 5% traffic</td>
                    </tr>
                    <tr>
                        <td><strong>Automated Analysis</strong></td>
                        <td>Catch issues early</td>
                        <td>Prometheus metrics + thresholds</td>
                    </tr>
                    <tr>
                        <td><strong>Multiple Metrics</strong></td>
                        <td>Comprehensive health check</td>
                        <td>Error rate + latency + success rate</td>
                    </tr>
                    <tr>
                        <td><strong>Gradual Rollout</strong></td>
                        <td>Progressive validation</td>
                        <td>5% ‚Üí 25% ‚Üí 50% ‚Üí 100%</td>
                    </tr>
                    <tr>
                        <td><strong>Auto Rollback</strong></td>
                        <td>Fast recovery</td>
                        <td>Failure limit in analysis</td>
                    </tr>
                </tbody>
            </table>

            <h2>Results</h2>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">90%</div>
                    <div class="metric-label">Fewer Incidents</div>
                    <div class="metric-sublabel">12 ‚Üí 1 per month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">50+</div>
                    <div class="metric-label">Daily Deployments</div>
                    <div class="metric-sublabel">Zero Downtime</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">15 min</div>
                    <div class="metric-label">Avg Rollout Time</div>
                    <div class="metric-sublabel">Automated</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">100%</div>
                    <div class="metric-label">Auto Rollback</div>
                    <div class="metric-sublabel">On Failure</div>
                </div>
            </div>

            <h2>Key Takeaways</h2>
            <ul>
                <li>Canary deployments reduce deployment risk by 90%</li>
                <li>Argo Rollouts provides automated progressive delivery</li>
                <li>Automated analysis with Prometheus catches issues early</li>
                <li>Gradual traffic shift (5% ‚Üí 25% ‚Üí 50% ‚Üí 100%) minimizes impact</li>
                <li>Automatic rollback on metric failures prevents incidents</li>
                <li>50+ daily deployments with zero downtime achieved</li>
                <li>Integration with Istio enables advanced traffic management</li>
            </ul>

            <div class="info-box">
                <strong>Production Tip:</strong> Start with manual canary (pause steps) to build confidence. Add automated analysis after 2 weeks. Set conservative thresholds initially (95% success rate, 5% error rate). Tighten after validating metrics.
            </div>
        </article>
    </main>

    <footer>
        <p>&copy; 2024 Suheb Ghare. All rights reserved.</p>
    </footer>

    <script src="blog-stats.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            blogStats.updateDisplay('argo-rollouts-canary-deployments');
            blogStats.incrementRead('argo-rollouts-canary-deployments');
        });
    </script>
</body>
</html>