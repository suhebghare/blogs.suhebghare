<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudFront + WAF Best Practices | Suheb Ghare</title>
    <meta name="description" content="Production-tested CloudFront and WAF configurations for high-traffic applications with 99.99% uptime">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Suheb Ghare</div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#blog-index">Blog Index</a>
                <a href="https://portfolio.suhebghare.tech" target="_blank">Portfolio</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <article class="blog-post">
            <h1>CloudFront + WAF Best Practices</h1>
            <p class="post-meta">Published on November 30, 2024 | 14 min read</p>

            <div class="info-box">
                <strong>Production Context:</strong> These configurations power applications serving 500M+ requests/month with 99.99% uptime, 45ms P95 latency, and 96% cache hit rate.
            </div>

            <h2>Why CloudFront + WAF?</h2>
            <p>CloudFront provides global CDN with edge caching. WAF adds security at the edge. Together, they block attacks before they reach your infrastructure while delivering content fast.</p>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">96%</div>
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-sublabel">Reduced Origin Load by 96%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">45ms</div>
                    <div class="metric-label">P95 Latency</div>
                    <div class="metric-sublabel">Global Average</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">99.7%</div>
                    <div class="metric-label">Attack Blocking Rate</div>
                    <div class="metric-sublabel">WAF at Edge</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$3,200</div>
                    <div class="metric-label">Monthly Savings</div>
                    <div class="metric-sublabel">Reduced Origin Costs</div>
                </div>
            </div>

            <h2>CloudFront Configuration</h2>

            <h3>Distribution with Security Headers</h3>
            <pre><code>resource "aws_cloudfront_distribution" "main" {
  enabled             = true
  is_ipv6_enabled     = true
  http_version        = "http2and3"
  price_class         = "PriceClass_All"
  default_root_object = "index.html"
  aliases             = ["example.com", "www.example.com"]

  origin {
    domain_name = aws_lb.main.dns_name
    origin_id   = "alb-origin"

    custom_origin_config {
      http_port              = 80
      https_port             = 443
      origin_protocol_policy = "https-only"
      origin_ssl_protocols   = ["TLSv1.2"]
      origin_read_timeout    = 60
      origin_keepalive_timeout = 5
    }

    custom_header {
      name  = "X-Origin-Verify"
      value = random_password.origin_verify.result
    }
  }

  default_cache_behavior {
    target_origin_id       = "alb-origin"
    viewer_protocol_policy = "redirect-to-https"
    allowed_methods        = ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"]
    cached_methods         = ["GET", "HEAD", "OPTIONS"]
    compress               = true

    forwarded_values {
      query_string = true
      headers      = ["Host", "CloudFront-Viewer-Country", "Authorization"]

      cookies {
        forward = "whitelist"
        whitelisted_names = ["session_id", "user_pref"]
      }
    }

    min_ttl     = 0
    default_ttl = 3600
    max_ttl     = 86400

    lambda_function_association {
      event_type   = "viewer-request"
      lambda_arn   = aws_lambda_function.security_headers.qualified_arn
      include_body = false
    }

    lambda_function_association {
      event_type   = "origin-response"
      lambda_arn   = aws_lambda_function.add_headers.qualified_arn
      include_body = false
    }
  }

  # Static assets with longer cache
  ordered_cache_behavior {
    path_pattern           = "/static/*"
    target_origin_id       = "alb-origin"
    viewer_protocol_policy = "redirect-to-https"
    allowed_methods        = ["GET", "HEAD"]
    cached_methods         = ["GET", "HEAD"]
    compress               = true

    forwarded_values {
      query_string = false
      cookies {
        forward = "none"
      }
    }

    min_ttl     = 86400
    default_ttl = 604800
    max_ttl     = 31536000
  }

  # API endpoints with no caching
  ordered_cache_behavior {
    path_pattern           = "/api/*"
    target_origin_id       = "alb-origin"
    viewer_protocol_policy = "https-only"
    allowed_methods        = ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"]
    cached_methods         = ["GET", "HEAD"]
    compress               = false

    forwarded_values {
      query_string = true
      headers      = ["*"]
      cookies {
        forward = "all"
      }
    }

    min_ttl     = 0
    default_ttl = 0
    max_ttl     = 0
  }

  restrictions {
    geo_restriction {
      restriction_type = "none"
    }
  }

  viewer_certificate {
    acm_certificate_arn      = aws_acm_certificate.main.arn
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1.2_2021"
  }

  web_acl_id = aws_wafv2_web_acl.cloudfront.arn

  logging_config {
    include_cookies = false
    bucket          = aws_s3_bucket.cloudfront_logs.bucket_domain_name
    prefix          = "cloudfront/"
  }

  tags = {
    Environment = "production"
  }
}</code></pre>

            <h3>Lambda@Edge for Security Headers</h3>
            <pre><code>exports.handler = async (event) => {
    const response = event.Records[0].cf.response;
    const headers = response.headers;

    headers['strict-transport-security'] = [{
        key: 'Strict-Transport-Security',
        value: 'max-age=63072000; includeSubdomains; preload'
    }];

    headers['x-content-type-options'] = [{
        key: 'X-Content-Type-Options',
        value: 'nosniff'
    }];

    headers['x-frame-options'] = [{
        key: 'X-Frame-Options',
        value: 'DENY'
    }];

    headers['x-xss-protection'] = [{
        key: 'X-XSS-Protection',
        value: '1; mode=block'
    }];

    headers['referrer-policy'] = [{
        key: 'Referrer-Policy',
        value: 'strict-origin-when-cross-origin'
    }];

    headers['content-security-policy'] = [{
        key: 'Content-Security-Policy',
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.example.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.example.com; frame-ancestors 'none';"
    }];

    headers['permissions-policy'] = [{
        key: 'Permissions-Policy',
        value: 'geolocation=(), microphone=(), camera=()'
    }];

    return response;
};</code></pre>

            <h2>WAF Configuration</h2>

            <h3>Comprehensive WAF Rules</h3>
            <pre><code>resource "aws_wafv2_web_acl" "cloudfront" {
  name  = "cloudfront-waf"
  scope = "CLOUDFRONT"

  default_action {
    allow {}
  }

  # AWS Managed Rules - Core Rule Set
  rule {
    name     = "AWSManagedRulesCommonRuleSet"
    priority = 1

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"

        rule_action_override {
          name = "SizeRestrictions_BODY"
          action_to_use {
            count {}
          }
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesCommonRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # SQL Injection Protection
  rule {
    name     = "AWSManagedRulesSQLiRuleSet"
    priority = 2

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesSQLiRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesSQLiRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # Known Bad Inputs
  rule {
    name     = "AWSManagedRulesKnownBadInputsRuleSet"
    priority = 3

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesKnownBadInputsRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesKnownBadInputsRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # Rate Limiting - Global
  rule {
    name     = "GlobalRateLimit"
    priority = 10

    action {
      block {
        custom_response {
          response_code = 429
        }
      }
    }

    statement {
      rate_based_statement {
        limit              = 2000
        aggregate_key_type = "IP"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "GlobalRateLimit"
      sampled_requests_enabled   = true
    }
  }

  # Rate Limiting - Login Endpoint
  rule {
    name     = "LoginRateLimit"
    priority = 11

    action {
      block {
        custom_response {
          response_code = 429
        }
      }
    }

    statement {
      rate_based_statement {
        limit              = 5
        aggregate_key_type = "IP"

        scope_down_statement {
          byte_match_statement {
            search_string = "/api/auth/login"
            field_to_match {
              uri_path {}
            }
            text_transformation {
              priority = 0
              type     = "LOWERCASE"
            }
            positional_constraint = "EXACTLY"
          }
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "LoginRateLimit"
      sampled_requests_enabled   = true
    }
  }

  # Geo-Blocking (Optional)
  rule {
    name     = "GeoBlock"
    priority = 20

    action {
      block {}
    }

    statement {
      geo_match_statement {
        country_codes = ["CN", "RU", "KP"]
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "GeoBlock"
      sampled_requests_enabled   = true
    }
  }

  # IP Reputation List
  rule {
    name     = "AWSManagedRulesAmazonIpReputationList"
    priority = 30

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesAmazonIpReputationList"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesAmazonIpReputationList"
      sampled_requests_enabled   = true
    }
  }

  # Bot Control
  rule {
    name     = "AWSManagedRulesBotControlRuleSet"
    priority = 40

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesBotControlRuleSet"
        vendor_name = "AWS"

        managed_rule_group_configs {
          aws_managed_rules_bot_control_rule_set {
            inspection_level = "TARGETED"
          }
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "BotControl"
      sampled_requests_enabled   = true
    }
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "cloudfront-waf"
    sampled_requests_enabled   = true
  }
}</code></pre>

            <h2>Origin Protection</h2>

            <h3>Verify Requests from CloudFront Only</h3>
            <pre><code># Generate random secret
resource "random_password" "origin_verify" {
  length  = 32
  special = false
}

# Store in Secrets Manager
resource "aws_secretsmanager_secret" "origin_verify" {
  name = "cloudfront-origin-verify"
}

resource "aws_secretsmanager_secret_version" "origin_verify" {
  secret_id     = aws_secretsmanager_secret.origin_verify.id
  secret_string = random_password.origin_verify.result
}

# ALB listener rule to verify header
resource "aws_lb_listener_rule" "verify_cloudfront" {
  listener_arn = aws_lb_listener.https.arn
  priority     = 1

  action {
    type = "fixed-response"
    fixed_response {
      content_type = "text/plain"
      message_body = "Direct access not allowed"
      status_code  = "403"
    }
  }

  condition {
    http_header {
      http_header_name = "X-Origin-Verify"
      values           = [random_password.origin_verify.result]
    }
  }
}</code></pre>

            <h2>Cache Optimization</h2>

            <h3>Cache Policy</h3>
            <pre><code>resource "aws_cloudfront_cache_policy" "optimized" {
  name        = "optimized-cache-policy"
  min_ttl     = 1
  default_ttl = 3600
  max_ttl     = 86400

  parameters_in_cache_key_and_forwarded_to_origin {
    enable_accept_encoding_gzip   = true
    enable_accept_encoding_brotli = true

    cookies_config {
      cookie_behavior = "whitelist"
      cookies {
        items = ["session_id", "user_pref"]
      }
    }

    headers_config {
      header_behavior = "whitelist"
      headers {
        items = ["CloudFront-Viewer-Country", "Authorization"]
      }
    }

    query_strings_config {
      query_string_behavior = "all"
    }
  }
}

resource "aws_cloudfront_origin_request_policy" "api" {
  name = "api-origin-request-policy"

  cookies_config {
    cookie_behavior = "all"
  }

  headers_config {
    header_behavior = "allViewer"
  }

  query_strings_config {
    query_string_behavior = "all"
  }
}</code></pre>

            <h3>Invalidation Automation</h3>
            <pre><code># Lambda to invalidate cache on deployment
import boto3
import os

cloudfront = boto3.client('cloudfront')
DISTRIBUTION_ID = os.environ['DISTRIBUTION_ID']

def handler(event, context):
    paths = event.get('paths', ['/*'])
    
    response = cloudfront.create_invalidation(
        DistributionId=DISTRIBUTION_ID,
        InvalidationBatch={
            'Paths': {
                'Quantity': len(paths),
                'Items': paths
            },
            'CallerReference': str(context.request_id)
        }
    )
    
    return {
        'statusCode': 200,
        'invalidation_id': response['Invalidation']['Id']
    }

# Terraform for Lambda
resource "aws_lambda_function" "invalidate_cache" {
  function_name = "cloudfront-invalidate"
  handler       = "index.handler"
  runtime       = "python3.11"
  role          = aws_iam_role.lambda_exec.arn

  environment {
    variables = {
      DISTRIBUTION_ID = aws_cloudfront_distribution.main.id
    }
  }
}</code></pre>

            <h2>Monitoring and Alerts</h2>

            <h3>CloudWatch Dashboard</h3>
            <pre><code>{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["AWS/CloudFront", "Requests", {"stat": "Sum"}],
          [".", "BytesDownloaded", {"stat": "Sum"}],
          [".", "4xxErrorRate", {"stat": "Average"}],
          [".", "5xxErrorRate", {"stat": "Average"}],
          [".", "CacheHitRate", {"stat": "Average"}]
        ],
        "period": 300,
        "stat": "Average",
        "region": "us-east-1",
        "title": "CloudFront Performance"
      }
    },
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["AWS/WAFV2", "BlockedRequests", {"stat": "Sum"}],
          [".", "AllowedRequests", {"stat": "Sum"}],
          [".", "CountedRequests", {"stat": "Sum"}]
        ],
        "period": 300,
        "stat": "Sum",
        "region": "us-east-1",
        "title": "WAF Activity"
      }
    }
  ]
}</code></pre>

            <h3>Alarms</h3>
            <pre><code>resource "aws_cloudwatch_metric_alarm" "high_error_rate" {
  alarm_name          = "cloudfront-high-error-rate"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "5xxErrorRate"
  namespace           = "AWS/CloudFront"
  period              = "300"
  statistic           = "Average"
  threshold           = "5"
  alarm_description   = "CloudFront 5xx error rate above 5%"
  alarm_actions       = [aws_sns_topic.alerts.arn]

  dimensions = {
    DistributionId = aws_cloudfront_distribution.main.id
  }
}

resource "aws_cloudwatch_metric_alarm" "low_cache_hit_rate" {
  alarm_name          = "cloudfront-low-cache-hit-rate"
  comparison_operator = "LessThanThreshold"
  evaluation_periods  = "3"
  metric_name         = "CacheHitRate"
  namespace           = "AWS/CloudFront"
  period              = "3600"
  statistic           = "Average"
  threshold           = "80"
  alarm_description   = "CloudFront cache hit rate below 80%"
  alarm_actions       = [aws_sns_topic.alerts.arn]

  dimensions = {
    DistributionId = aws_cloudfront_distribution.main.id
  }
}

resource "aws_cloudwatch_metric_alarm" "waf_attack_detected" {
  alarm_name          = "waf-attack-detected"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "BlockedRequests"
  namespace           = "AWS/WAFV2"
  period              = "300"
  statistic           = "Sum"
  threshold           = "1000"
  alarm_description   = "WAF blocking high volume of requests"
  alarm_actions       = [aws_sns_topic.security_alerts.arn]

  dimensions = {
    WebACL = aws_wafv2_web_acl.cloudfront.name
    Rule   = "GlobalRateLimit"
  }
}</code></pre>

            <h2>Cost Optimization</h2>

            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Usage</th>
                            <th>Monthly Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CloudFront Requests</td>
                            <td>500M requests</td>
                            <td>$400</td>
                        </tr>
                        <tr>
                            <td>CloudFront Data Transfer</td>
                            <td>10TB</td>
                            <td>$850</td>
                        </tr>
                        <tr>
                            <td>Lambda@Edge</td>
                            <td>500M invocations</td>
                            <td>$50</td>
                        </tr>
                        <tr>
                            <td>AWS WAF</td>
                            <td>Web ACL + 8 rules + 500M requests</td>
                            <td>$320</td>
                        </tr>
                        <tr>
                            <td>CloudWatch Logs</td>
                            <td>100GB</td>
                            <td>$50</td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td></td>
                            <td><strong>$1,670/month</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p><strong>Savings:</strong> 96% cache hit rate reduced origin costs by $3,200/month (EC2, ALB, data transfer), resulting in net savings of $1,530/month.</p>

            <h2>Results</h2>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">96%</div>
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-sublabel">Optimized Cache Policies</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">45ms</div>
                    <div class="metric-label">P95 Latency</div>
                    <div class="metric-sublabel">Global Average</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">99.7%</div>
                    <div class="metric-label">Attack Blocking</div>
                    <div class="metric-sublabel">WAF at Edge</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$1,530</div>
                    <div class="metric-label">Net Monthly Savings</div>
                    <div class="metric-sublabel">After CloudFront Costs</div>
                </div>
            </div>

            <h2>Key Takeaways</h2>
            <ul>
                <li>CloudFront + WAF provides security and performance at the edge</li>
                <li>96% cache hit rate reduces origin load and costs significantly</li>
                <li>Lambda@Edge adds security headers without origin changes</li>
                <li>WAF managed rules block 99.7% of attacks automatically</li>
                <li>Origin verification prevents direct access bypassing CloudFront</li>
                <li>Comprehensive monitoring enables proactive issue detection</li>
                <li>Net savings of $1,530/month after CloudFront costs</li>
            </ul>

            <div class="info-box">
                <strong>Production Tip:</strong> Start with AWS managed WAF rules and default cache policies. Monitor for 2 weeks, then optimize based on actual traffic patterns. This prevents over-engineering while building confidence in your configuration.
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Suheb Ghare. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>