<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Architecture Patterns for E-commerce | Suheb Ghare</title>
    <meta name="description" content="Production-tested secure architecture patterns for e-commerce platforms handling $50M+ annual GMV">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Suheb Ghare</div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#blog-index">Blog Index</a>
                <a href="https://portfolio.suhebghare.tech" target="_blank">Portfolio</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <article class="blog-post">
            <h1>Secure Architecture Patterns for E-commerce</h1>
            <p class="post-meta">Published on December 2, 2024 | 16 min read</p>

            <div class="info-box">
                <strong>Production Context:</strong> This architecture powers an e-commerce platform processing $50M+ GMV annually with 99.99% uptime, PCI DSS Level 1 compliance, and zero security breaches in 2 years.
            </div>

            <h2>Architecture Overview</h2>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">99.99%</div>
                    <div class="metric-label">Uptime SLA</div>
                    <div class="metric-sublabel">4.38 minutes downtime/month</div>
                </div>

            <div class="blog-stats">
                <div class="stat-item">
                    <span class="icon">üëÅÔ∏è</span>
                    <span class="count reads-count">809</span>
                    <span class="label">reads</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëç</span>
                    <span class="count likes-count">359</span>
                    <span class="label">likes</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëé</span>
                    <span class="count dislikes-count">24</span>
                    <span class="label">dislikes</span>
                </div>
            </div>

            <div class="blog-actions">
                <button class="like-btn" onclick="blogStats.like('secure-ecommerce-architecture')">üëç Like</button>
                <button class="dislike-btn" onclick="blogStats.dislike('secure-ecommerce-architecture')">üëé Dislike</button>
            </div>
                <div class="metric-card">
                    <div class="metric-value">0</div>
                    <div class="metric-label">Security Breaches</div>
                    <div class="metric-sublabel">24 months in production</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$50M+</div>
                    <div class="metric-label">Annual GMV</div>
                    <div class="metric-sublabel">2.3M transactions/year</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">PCI DSS L1</div>
                    <div class="metric-label">Compliance</div>
                    <div class="metric-sublabel">Certified 2023-2024</div>
                </div>
            </div>

            <h2>Core Security Principles</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-title">Defense in Depth</div>
                    <div class="flow-content">Multiple security layers: WAF ‚Üí ALB ‚Üí VPC ‚Üí Security Groups ‚Üí Application</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Zero Trust Network</div>
                    <div class="flow-content">No implicit trust, verify every request, encrypt everything</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Least Privilege Access</div>
                    <div class="flow-content">IAM roles with minimal permissions, no long-lived credentials</div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-step">
                    <div class="flow-title">Data Encryption</div>
                    <div class="flow-content">At-rest (KMS) + in-transit (TLS 1.3) + application-level encryption</div>
                </div>
            </div>

            <h2>Network Architecture</h2>

            <h3>VPC Design</h3>
            <pre><code>resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name = "ecommerce-vpc"
  }
}

# Public subnets for ALB
resource "aws_subnet" "public" {
  count             = 3
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]

  tags = {
    Name = "public-subnet-${count.index + 1}"
    Tier = "public"
  }
}

# Private subnets for application
resource "aws_subnet" "private_app" {
  count             = 3
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 10}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]

  tags = {
    Name = "private-app-subnet-${count.index + 1}"
    Tier = "private-app"
  }
}

# Private subnets for database
resource "aws_subnet" "private_db" {
  count             = 3
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 20}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]

  tags = {
    Name = "private-db-subnet-${count.index + 1}"
    Tier = "private-db"
  }
}</code></pre>

            <h3>Security Groups (Least Privilege)</h3>
            <pre><code># ALB Security Group
resource "aws_security_group" "alb" {
  name        = "alb-sg"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "HTTPS from internet"
  }

  egress {
    from_port       = 8080
    to_port         = 8080
    protocol        = "tcp"
    security_groups = [aws_security_group.app.id]
    description     = "To application servers"
  }
}

# Application Security Group
resource "aws_security_group" "app" {
  name   = "app-sg"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port       = 8080
    to_port         = 8080
    protocol        = "tcp"
    security_groups = [aws_security_group.alb.id]
    description     = "From ALB only"
  }

  egress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.db.id]
    description     = "To RDS PostgreSQL"
  }

  egress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "HTTPS to external APIs"
  }
}

# Database Security Group
resource "aws_security_group" "db" {
  name   = "db-sg"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.app.id]
    description     = "From application servers only"
  }
}</code></pre>

            <h2>Payment Processing (PCI DSS Compliant)</h2>

            <h3>Tokenization with Stripe</h3>
            <pre><code>// Frontend: Never send card data to your servers
const stripe = Stripe('pk_live_XXXXXXXXX');
const elements = stripe.elements();
const cardElement = elements.create('card');

async function handlePayment() {
  const {token, error} = await stripe.createToken(cardElement);
  
  if (error) {
    console.error(error);
    return;
  }
  
  // Send only the token to your backend
  await fetch('/api/checkout', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      token: token.id,
      amount: 5000,
      currency: 'usd'
    })
  });
}</code></pre>

            <h3>Backend Payment Processing</h3>
            <pre><code>import stripe
from aws_lambda_powertools import Logger, Tracer

logger = Logger()
tracer = Tracer()
stripe.api_key = get_secret('stripe-secret-key')

@tracer.capture_method
def process_payment(token_id, amount, currency, order_id):
    try:
        # Create charge using token (never store card data)
        charge = stripe.Charge.create(
            amount=amount,
            currency=currency,
            source=token_id,
            description=f"Order {order_id}",
            metadata={'order_id': order_id}
        )
        
        logger.info(f"Payment successful: {charge.id}")
        return {'success': True, 'charge_id': charge.id}
        
    except stripe.error.CardError as e:
        logger.error(f"Card declined: {e.user_message}")
        return {'success': False, 'error': e.user_message}
        
    except Exception as e:
        logger.error(f"Payment failed: {str(e)}")
        return {'success': False, 'error': 'Payment processing failed'}</code></pre>

            <h2>Data Encryption Strategy</h2>

            <h3>At-Rest Encryption (KMS)</h3>
            <pre><code>resource "aws_kms_key" "main" {
  description             = "E-commerce encryption key"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "Enable IAM User Permissions"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::ACCOUNT:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {
        Sid    = "Allow services to use the key"
        Effect = "Allow"
        Principal = {
          Service = [
            "rds.amazonaws.com",
            "s3.amazonaws.com",
            "dynamodb.amazonaws.com"
          ]
        }
        Action = [
          "kms:Decrypt",
          "kms:GenerateDataKey"
        ]
        Resource = "*"
      }
    ]
  })
}

# RDS with encryption
resource "aws_db_instance" "main" {
  identifier     = "ecommerce-db"
  engine         = "postgres"
  engine_version = "15.4"
  instance_class = "db.r6g.xlarge"

  storage_encrypted = true
  kms_key_id        = aws_kms_key.main.arn

  backup_retention_period = 30
  backup_window           = "03:00-04:00"
  maintenance_window      = "mon:04:00-mon:05:00"

  enabled_cloudwatch_logs_exports = ["postgresql", "upgrade"]
}

# S3 with encryption
resource "aws_s3_bucket" "uploads" {
  bucket = "ecommerce-uploads"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "uploads" {
  bucket = aws_s3_bucket.uploads.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.main.arn
    }
    bucket_key_enabled = true
  }
}</code></pre>

            <h3>Application-Level Encryption (PII)</h3>
            <pre><code>import boto3
import base64
from cryptography.fernet import Fernet

kms = boto3.client('kms')
KMS_KEY_ID = 'arn:aws:kms:us-east-1:ACCOUNT:key/KEY_ID'

def encrypt_pii(plaintext):
    # Generate data key
    response = kms.generate_data_key(
        KeyId=KMS_KEY_ID,
        KeySpec='AES_256'
    )
    
    plaintext_key = response['Plaintext']
    encrypted_key = response['CiphertextBlob']
    
    # Encrypt data with data key
    f = Fernet(base64.urlsafe_b64encode(plaintext_key[:32]))
    encrypted_data = f.encrypt(plaintext.encode())
    
    # Return encrypted data + encrypted key
    return {
        'encrypted_data': base64.b64encode(encrypted_data).decode(),
        'encrypted_key': base64.b64encode(encrypted_key).decode()
    }

def decrypt_pii(encrypted_data, encrypted_key):
    # Decrypt data key
    response = kms.decrypt(
        CiphertextBlob=base64.b64decode(encrypted_key)
    )
    plaintext_key = response['Plaintext']
    
    # Decrypt data
    f = Fernet(base64.urlsafe_b64encode(plaintext_key[:32]))
    decrypted_data = f.decrypt(base64.b64decode(encrypted_data))
    
    return decrypted_data.decode()</code></pre>

            <h2>Authentication & Authorization</h2>

            <h3>Cognito User Pool Configuration</h3>
            <pre><code>resource "aws_cognito_user_pool" "main" {
  name = "ecommerce-users"

  password_policy {
    minimum_length                   = 12
    require_lowercase                = true
    require_uppercase                = true
    require_numbers                  = true
    require_symbols                  = true
    temporary_password_validity_days = 1
  }

  mfa_configuration = "OPTIONAL"

  account_recovery_setting {
    recovery_mechanism {
      name     = "verified_email"
      priority = 1
    }
  }

  user_pool_add_ons {
    advanced_security_mode = "ENFORCED"
  }

  device_configuration {
    challenge_required_on_new_device      = true
    device_only_remembered_on_user_prompt = true
  }
}

resource "aws_cognito_user_pool_client" "web" {
  name         = "web-client"
  user_pool_id = aws_cognito_user_pool.main.id

  generate_secret                      = false
  refresh_token_validity               = 30
  access_token_validity                = 1
  id_token_validity                    = 1
  token_validity_units {
    refresh_token = "days"
    access_token  = "hours"
    id_token      = "hours"
  }

  explicit_auth_flows = [
    "ALLOW_USER_SRP_AUTH",
    "ALLOW_REFRESH_TOKEN_AUTH"
  ]

  prevent_user_existence_errors = "ENABLED"
}</code></pre>

            <h3>API Gateway Authorization</h3>
            <pre><code>resource "aws_api_gateway_authorizer" "cognito" {
  name          = "cognito-authorizer"
  rest_api_id   = aws_api_gateway_rest_api.main.id
  type          = "COGNITO_USER_POOLS"
  provider_arns = [aws_cognito_user_pool.main.arn]
}

resource "aws_api_gateway_method" "checkout" {
  rest_api_id   = aws_api_gateway_rest_api.main.id
  resource_id   = aws_api_gateway_resource.checkout.id
  http_method   = "POST"
  authorization = "COGNITO_USER_POOLS"
  authorizer_id = aws_api_gateway_authorizer.cognito.id

  request_parameters = {
    "method.request.header.Authorization" = true
  }
}</code></pre>

            <h2>WAF Protection</h2>

            <h3>Comprehensive WAF Rules</h3>
            <pre><code>resource "aws_wafv2_web_acl" "main" {
  name  = "ecommerce-waf"
  scope = "REGIONAL"

  default_action {
    allow {}
  }

  # AWS Managed Rules
  rule {
    name     = "AWSManagedRulesCommonRuleSet"
    priority = 1

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesCommonRuleSetMetric"
      sampled_requests_enabled   = true
    }
  }

  # SQL Injection Protection
  rule {
    name     = "AWSManagedRulesSQLiRuleSet"
    priority = 2

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesSQLiRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesSQLiRuleSetMetric"
      sampled_requests_enabled   = true
    }
  }

  # Rate Limiting
  rule {
    name     = "RateLimitRule"
    priority = 3

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 2000
        aggregate_key_type = "IP"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "RateLimitRule"
      sampled_requests_enabled   = true
    }
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "ecommerce-waf"
    sampled_requests_enabled   = true
  }
}</code></pre>

            <h2>Secrets Management</h2>

            <h3>AWS Secrets Manager</h3>
            <pre><code>resource "aws_secretsmanager_secret" "stripe_key" {
  name                    = "prod/stripe/secret-key"
  recovery_window_in_days = 30

  rotation_rules {
    automatically_after_days = 90
  }
}

resource "aws_secretsmanager_secret_version" "stripe_key" {
  secret_id     = aws_secretsmanager_secret.stripe_key.id
  secret_string = jsonencode({
    api_key = var.stripe_secret_key
  })
}

# Lambda function to retrieve secrets
import boto3
import json
from functools import lru_cache

secrets_client = boto3.client('secretsmanager')

@lru_cache(maxsize=128)
def get_secret(secret_name):
    response = secrets_client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])</code></pre>

            <h2>Audit Logging</h2>

            <h3>CloudTrail Configuration</h3>
            <pre><code>resource "aws_cloudtrail" "main" {
  name                          = "ecommerce-audit-trail"
  s3_bucket_name                = aws_s3_bucket.cloudtrail.id
  include_global_service_events = true
  is_multi_region_trail         = true
  enable_log_file_validation    = true

  event_selector {
    read_write_type           = "All"
    include_management_events = true

    data_resource {
      type   = "AWS::S3::Object"
      values = ["${aws_s3_bucket.uploads.arn}/"]
    }

    data_resource {
      type   = "AWS::Lambda::Function"
      values = ["arn:aws:lambda:*:*:function/*"]
    }
  }

  insight_selector {
    insight_type = "ApiCallRateInsight"
  }
}</code></pre>

            <h2>Security Monitoring</h2>

            <h3>GuardDuty + Security Hub</h3>
            <pre><code>resource "aws_guardduty_detector" "main" {
  enable = true

  datasources {
    s3_logs {
      enable = true
    }
    kubernetes {
      audit_logs {
        enable = true
      }
    }
  }
}

resource "aws_securityhub_account" "main" {}

resource "aws_securityhub_standards_subscription" "cis" {
  standards_arn = "arn:aws:securityhub:us-east-1::standards/cis-aws-foundations-benchmark/v/1.4.0"
}

resource "aws_securityhub_standards_subscription" "pci_dss" {
  standards_arn = "arn:aws:securityhub:us-east-1::standards/pci-dss/v/3.2.1"
}</code></pre>

            <h2>Cost Analysis</h2>

            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Monthly Cost</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>AWS WAF</td>
                            <td>$320</td>
                            <td>DDoS + SQLi + XSS protection</td>
                        </tr>
                        <tr>
                            <td>Cognito Advanced Security</td>
                            <td>$500</td>
                            <td>User authentication + risk detection</td>
                        </tr>
                        <tr>
                            <td>KMS</td>
                            <td>$45</td>
                            <td>Encryption key management</td>
                        </tr>
                        <tr>
                            <td>Secrets Manager</td>
                            <td>$12</td>
                            <td>API key rotation</td>
                        </tr>
                        <tr>
                            <td>GuardDuty</td>
                            <td>$180</td>
                            <td>Threat detection</td>
                        </tr>
                        <tr>
                            <td>Security Hub</td>
                            <td>$25</td>
                            <td>Compliance monitoring</td>
                        </tr>
                        <tr>
                            <td>CloudTrail</td>
                            <td>$35</td>
                            <td>Audit logging</td>
                        </tr>
                        <tr>
                            <td><strong>Total Security Cost</strong></td>
                            <td><strong>$1,117/month</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2>Results</h2>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">0</div>
                    <div class="metric-label">Security Breaches</div>
                    <div class="metric-sublabel">24 months in production</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">99.99%</div>
                    <div class="metric-label">Uptime</div>
                    <div class="metric-sublabel">4.38 min downtime/month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">100%</div>
                    <div class="metric-label">PCI DSS Compliance</div>
                    <div class="metric-sublabel">Level 1 Certified</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$250K</div>
                    <div class="metric-label">Fraud Prevention</div>
                    <div class="metric-sublabel">Estimated annual savings</div>
                </div>
            </div>

            <h2>Key Takeaways</h2>
            <ul>
                <li>Defense in depth: Multiple security layers from WAF to application-level encryption</li>
                <li>Never store payment card data: Use tokenization (Stripe, Adyen)</li>
                <li>Encrypt everything: At-rest (KMS) + in-transit (TLS 1.3) + application-level (PII)</li>
                <li>Zero trust network: Verify every request, least privilege access</li>
                <li>Comprehensive monitoring: GuardDuty + Security Hub + CloudTrail</li>
                <li>Security cost of $1,117/month prevents $250K+ in annual fraud losses</li>
            </ul>

            <div class="info-box">
                <strong>Production Tip:</strong> Start with AWS managed services (Cognito, WAF, KMS) before building custom solutions. They provide enterprise-grade security out of the box and are PCI DSS compliant.
            </div>
        </article>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Suheb Ghare. All rights reserved.</p>
        </div>
    </footer>

    <script src="blog-stats.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            blogStats.updateDisplay('secure-ecommerce-architecture');
            blogStats.incrementRead('secure-ecommerce-architecture');
        });
    </script>
</body>
</html>