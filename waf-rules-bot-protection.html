<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designing WAF Rules That Stop Bots - Suheb Ghare</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Suheb Ghare</div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#blog-index">Blog Index</a>
                <a href="https://portfolio.suhebghare.tech" target="_blank">Portfolio</a>
            </div>
        </nav>
    </header>

    <main>
        <a href="index.html" class="back-link">‚Üê Back to Home</a>
        
        <article class="blog-content">
            <div class="blog-header">
                <h1>Designing WAF Rules That Actually Stop Bots</h1>
                <div class="blog-meta">Published on December 5, 2024 | 14 min read</div>
            </div>


            <div class="blog-stats">
                <div class="stat-item">
                    <span class="icon">üëÅÔ∏è</span>
                    <span class="count reads-count">777</span>
                    <span class="label">reads</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëç</span>
                    <span class="count likes-count">240</span>
                    <span class="label">likes</span>
                </div>
                <div class="stat-item">
                    <span class="icon">üëé</span>
                    <span class="count dislikes-count">38</span>
                    <span class="label">dislikes</span>
                </div>
            </div>

            <div class="blog-actions">
                <button class="like-btn" onclick="blogStats.like('waf-rules-bot-protection')">üëç Like</button>
                <button class="dislike-btn" onclick="blogStats.dislike('waf-rules-bot-protection')">üëé Dislike</button>
            </div>
            <h2>The Bot Problem</h2>
            <p>Bots account for 40% of all web traffic. Bad bots scrape content, abuse APIs, and launch attacks. Here's how we built WAF rules that blocked 99.7% of malicious bots while allowing legitimate traffic.</p>

            <div class="grid-2">
                <div class="metric-card">
                    <h4>Before WAF Rules</h4>
                    <div class="metric-value">2.3M</div>
                    <p>Bot requests per day</p>
                </div>
                <div class="metric-card">
                    <h4>After WAF Rules</h4>
                    <div class="metric-value">7K</div>
                    <p>Bot requests per day (99.7% blocked)</p>
                </div>
            </div>

            <h2>Understanding Bot Types</h2>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Bot Type</th>
                        <th>Behavior</th>
                        <th>Detection Method</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Good Bots</td>
                        <td>Search engines, monitoring</td>
                        <td>User-Agent verification</td>
                        <td><span class="cost-badge low">Allow</span></td>
                    </tr>
                    <tr>
                        <td>Scrapers</td>
                        <td>Content theft, price monitoring</td>
                        <td>Rate limiting, fingerprinting</td>
                        <td><span class="cost-badge high">Block</span></td>
                    </tr>
                    <tr>
                        <td>Credential Stuffers</td>
                        <td>Login attempts with stolen credentials</td>
                        <td>Rate limiting, CAPTCHA</td>
                        <td><span class="cost-badge high">Challenge</span></td>
                    </tr>
                    <tr>
                        <td>DDoS Bots</td>
                        <td>Overwhelming traffic</td>
                        <td>Rate limiting, geo-blocking</td>
                        <td><span class="cost-badge high">Block</span></td>
                    </tr>
                </tbody>
            </table>

            <h2>AWS WAF Rule Architecture</h2>

            <img src="images/waf1.png" alt="WAF Rule Evaluation Flow" style="max-width: 100%; height: auto; margin: 20px 0;">

            <div class="diagram">
                <h4>WAF Rule Evaluation Flow</h4>
                <div class="flow-step">Request Arrives</div>
                <div class="flow-step">Rate Limit Check</div>
                <div class="flow-step">Geo-Blocking</div>
                <div class="flow-step">Bot Detection</div>
                <div class="flow-step">Allow/Block</div>
            </div>

            <h2>Rule 1: Rate Limiting</h2>

            <div class="info-box success">
                <strong>Purpose:</strong> Prevent brute force attacks and API abuse by limiting requests per IP
            </div>

            <pre><code>{
  "Name": "RateLimitRule",
  "Priority": 1,
  "Statement": {
    "RateBasedStatement": {
      "Limit": 2000,
      "AggregateKeyType": "IP",
      "ScopeDownStatement": {
        "NotStatement": {
          "Statement": {
            "ByteMatchStatement": {
              "SearchString": "Googlebot",
              "FieldToMatch": {
                "SingleHeader": {
                  "Name": "user-agent"
                }
              },
              "TextTransformations": [{
                "Priority": 0,
                "Type": "LOWERCASE"
              }],
              "PositionalConstraint": "CONTAINS"
            }
          }
        }
      }
    }
  },
  "Action": {
    "Block": {}
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "RateLimitRule"
  }
}</code></pre>

            <h3>Rate Limit Tiers</h3>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Limit</th>
                        <th>Window</th>
                        <th>Reasoning</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>/api/login</td>
                        <td>5 requests</td>
                        <td>5 minutes</td>
                        <td>Prevent credential stuffing</td>
                    </tr>
                    <tr>
                        <td>/api/search</td>
                        <td>100 requests</td>
                        <td>5 minutes</td>
                        <td>Prevent scraping</td>
                    </tr>
                    <tr>
                        <td>/api/*</td>
                        <td>2000 requests</td>
                        <td>5 minutes</td>
                        <td>General API protection</td>
                    </tr>
                    <tr>
                        <td>Static assets</td>
                        <td>10000 requests</td>
                        <td>5 minutes</td>
                        <td>Allow CDN caching</td>
                    </tr>
                </tbody>
            </table>

            <h2>Rule 2: User-Agent Filtering</h2>

            <div class="info-box warning">
                <strong>Challenge:</strong> Bots often use fake or missing User-Agent headers
            </div>

            <pre><code>{
  "Name": "BlockBadUserAgents",
  "Priority": 2,
  "Statement": {
    "OrStatement": {
      "Statements": [
        {
          "ByteMatchStatement": {
            "SearchString": "python-requests",
            "FieldToMatch": {
              "SingleHeader": {"Name": "user-agent"}
            },
            "TextTransformations": [{"Priority": 0, "Type": "LOWERCASE"}],
            "PositionalConstraint": "CONTAINS"
          }
        },
        {
          "ByteMatchStatement": {
            "SearchString": "curl",
            "FieldToMatch": {
              "SingleHeader": {"Name": "user-agent"}
            },
            "TextTransformations": [{"Priority": 0, "Type": "LOWERCASE"}],
            "PositionalConstraint": "CONTAINS"
          }
        },
        {
          "SizeConstraintStatement": {
            "FieldToMatch": {
              "SingleHeader": {"Name": "user-agent"}
            },
            "ComparisonOperator": "LT",
            "Size": 10,
            "TextTransformations": [{"Priority": 0, "Type": "NONE"}]
          }
        }
      ]
    }
  },
  "Action": {"Block": {}},
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BadUserAgents"
  }
}</code></pre>

            <h3>Common Bot User-Agents to Block</h3>

            <ul class="icon-list cross">
                <li>python-requests</li>
                <li>curl</li>
                <li>wget</li>
                <li>scrapy</li>
                <li>selenium</li>
                <li>phantomjs</li>
                <li>Empty or very short User-Agent</li>
            </ul>

            <h2>Rule 3: Geographic Blocking</h2>

            <pre><code>{
  "Name": "GeoBlockHighRiskCountries",
  "Priority": 3,
  "Statement": {
    "GeoMatchStatement": {
      "CountryCodes": ["CN", "RU", "KP", "IR"]
    }
  },
  "Action": {"Block": {}},
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "GeoBlock"
  }
}</code></pre>

            <div class="info-box">
                <strong>Note:</strong> Only block countries where you have no legitimate users. Monitor false positives carefully.
            </div>

            <h2>Rule 4: SQL Injection & XSS Protection</h2>

            <pre><code>{
  "Name": "SQLInjectionProtection",
  "Priority": 4,
  "Statement": {
    "OrStatement": {
      "Statements": [
        {
          "SqliMatchStatement": {
            "FieldToMatch": {"QueryString": {}},
            "TextTransformations": [
              {"Priority": 0, "Type": "URL_DECODE"},
              {"Priority": 1, "Type": "HTML_ENTITY_DECODE"}
            ]
          }
        },
        {
          "XssMatchStatement": {
            "FieldToMatch": {"Body": {}},
            "TextTransformations": [
              {"Priority": 0, "Type": "URL_DECODE"},
              {"Priority": 1, "Type": "HTML_ENTITY_DECODE"}
            ]
          }
        }
      ]
    }
  },
  "Action": {"Block": {}},
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "SQLiXSSProtection"
  }
}</code></pre>

            <h2>Rule 5: Bot Challenge (CAPTCHA)</h2>

            <pre><code>{
  "Name": "BotChallengeRule",
  "Priority": 5,
  "Statement": {
    "AndStatement": {
      "Statements": [
        {
          "RateBasedStatement": {
            "Limit": 100,
            "AggregateKeyType": "IP"
          }
        },
        {
          "ByteMatchStatement": {
            "SearchString": "/api/login",
            "FieldToMatch": {"UriPath": {}},
            "TextTransformations": [{"Priority": 0, "Type": "LOWERCASE"}],
            "PositionalConstraint": "STARTS_WITH"
          }
        }
      ]
    }
  },
  "Action": {
    "Captcha": {
      "CustomRequestHandling": {
        "InsertHeaders": [
          {
            "Name": "x-captcha-required",
            "Value": "true"
          }
        ]
      }
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BotChallenge"
  }
}</code></pre>

            <h2>Advanced: Bot Fingerprinting</h2>

            <h3>TLS Fingerprinting</h3>

            <div class="info-box success">
                <strong>Technique:</strong> Analyze TLS handshake patterns to identify bots
            </div>

            <pre><code>{
  "Name": "TLSFingerprintRule",
  "Priority": 6,
  "Statement": {
    "NotStatement": {
      "Statement": {
        "ByteMatchStatement": {
          "SearchString": "771,4865-4866-4867",
          "FieldToMatch": {
            "SingleHeader": {"Name": "ja3-fingerprint"}
          },
          "TextTransformations": [{"Priority": 0, "Type": "NONE"}],
          "PositionalConstraint": "CONTAINS"
        }
      }
    }
  },
  "Action": {"Block": {}},
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "TLSFingerprint"
  }
}</code></pre>

            <h2>Monitoring & Tuning</h2>

            <h3>Key Metrics to Track</h3>

            <div class="grid-2">
                <div class="metric-card">
                    <h4>Block Rate</h4>
                    <div class="metric-value">15%</div>
                    <p>Requests blocked by WAF</p>
                </div>
                <div class="metric-card">
                    <h4>False Positives</h4>
                    <div class="metric-value">&lt;0.1%</div>
                    <p>Legitimate requests blocked</p>
                </div>
            </div>

            <h3>CloudWatch Alarms</h3>

            <pre><code>resource "aws_cloudwatch_metric_alarm" "waf_block_spike" {
  alarm_name          = "waf-block-rate-spike"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "BlockedRequests"
  namespace           = "AWS/WAFV2"
  period              = "300"
  statistic           = "Sum"
  threshold           = "10000"
  alarm_description   = "WAF blocking unusual traffic"
  alarm_actions       = [aws_sns_topic.alerts.arn]
}</code></pre>

            <h2>Testing Your WAF Rules</h2>

            <h3>Test Script</h3>

            <pre><code>#!/bin/bash

# Test rate limiting
echo "Testing rate limit..."
for i in {1..2100}; do
  curl -s https://api.example.com/test > /dev/null
done

# Test bad user agent
echo "Testing user-agent blocking..."
curl -A "python-requests/2.28.0" https://api.example.com/test

# Test SQL injection
echo "Testing SQLi protection..."
curl "https://api.example.com/search?q=1' OR '1'='1"

# Test XSS
echo "Testing XSS protection..."
curl -X POST https://api.example.com/comment \
  -d "text=&lt;script&gt;alert('xss')&lt;/script&gt;"</code></pre>

            <h2>Cost Analysis</h2>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Cost</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>WAF Web ACL</td>
                        <td>$5/month</td>
                        <td>Per Web ACL</td>
                    </tr>
                    <tr>
                        <td>WAF Rules</td>
                        <td>$1/rule/month</td>
                        <td>6 rules = $6/month</td>
                    </tr>
                    <tr>
                        <td>Requests</td>
                        <td>$0.60 per 1M</td>
                        <td>100M requests = $60/month</td>
                    </tr>
                    <tr>
                        <td>CAPTCHA</td>
                        <td>$0.40 per 1000</td>
                        <td>Optional</td>
                    </tr>
                </tbody>
            </table>

            <div class="metric-card">
                <h4>Total Monthly Cost</h4>
                <div class="metric-value">$71</div>
                <p>For 100M requests with 6 rules</p>
            </div>

            <h2>Best Practices</h2>

            <div class="info-box success">
                <ul class="icon-list">
                    <li>Start with logging mode, analyze traffic patterns</li>
                    <li>Whitelist known good bots (Googlebot, etc.)</li>
                    <li>Use tiered rate limits based on endpoint sensitivity</li>
                    <li>Monitor false positives daily</li>
                    <li>Combine multiple detection methods</li>
                    <li>Use CAPTCHA for suspicious but not clearly malicious traffic</li>
                    <li>Keep rules updated based on attack patterns</li>
                    <li>Test rules in staging before production</li>
                </ul>
            </div>

            <h2>Conclusion</h2>
            <p>Effective WAF rules require layered defense: rate limiting, user-agent filtering, geo-blocking, and bot challenges. Our 6-rule setup blocked 99.7% of bot traffic while maintaining zero false positives for legitimate users. Start with conservative rules, monitor closely, and tune based on your traffic patterns. The $71/month investment saved us $2,000/month in infrastructure costs from bot traffic.</p>
        </article>
    </main>

    <footer>
        <p>&copy; 2024 Suheb Ghare. All rights reserved.</p>
    </footer>

    <script src="blog-stats.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            blogStats.updateDisplay('waf-rules-bot-protection');
            blogStats.incrementRead('waf-rules-bot-protection');
        });
    </script>
</body>
</html>
